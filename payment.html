<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Linkin Park</title>
    <meta author="linkins">
    <meta name="description" content="TODO">
    <meta name="keywords" content="TODO">
    <meta name="viewport" content="width=device-width">
    
    <link rel="stylesheet" href="asset/css/payment.css" media="screen">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" href="asset/img/favicon.ico" type="image/x-icon">
</head>
<body>
    <form id="cardForm" action="php/payment.php" method="POST">
        <div class="container">
            <div class="card">
                <button class="proceed" type="submit">
                    <svg class="sendicon" width="24" height="24" viewBox="0 0 24 24">
                        <path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z"></path>
                    </svg>
                </button>

                <img src="https://seeklogo.com/images/V/VISA-logo-62D5B26FE1-seeklogo.com.png" class="logo-card">

                <label>Card number:</label>
                <input id="n_carta" type="text" class="input n_carta" name="n_carta" placeholder="1234 5678 9101 1121" maxlength="16" required>
                
                <label>Nome Completo Proprietario Carta:</label>
                <input id="nome" class="input nome" name="nome" placeholder="Mario Rossi" required>
                
                <label for="data_scadenza">Data di Scadenza:</label>
                <input type="date" id="data_scadenza" name="data_scadenza" required>
                
                <label class="toleft">CCV:</label>
                <input id="ccv" class="input toleft ccv" name="ccv" placeholder="321" maxlength="4" required>
            </div>
            
            <div class="receipt">
                <div class="col">
                    <p>Costo:</p>
                    <h2 class="cost" id="subtotal">€0.00</h2><br>
                    <p>Utente:</p>
                    <h2 class="user" id="user-name">Nome Cognome</h2>
                </div>
                
                <div class="col">
                    <p>Lista degli acquisti:</p>
                    <div id="bought-items">
                        <!-- I prodotti del carrello verranno aggiunti qui tramite JavaScript -->
                    </div>
                </div>
                
                <p class="comprobe">Con la <strong>ricevuta di avvenuto pagamento</strong> potrai ritirare la merce nel Linkin Park Store a te più vicino.</p>
            </div>
        </div>
    </form>
    
    <script>
        // Real-time validation for the card number input
        const nCartaInput = document.getElementById('n_carta');
        const ccvInput = document.getElementById('ccv');

        // Allow only numbers and restrict length to 16 digits for card number
        nCartaInput.addEventListener('input', function () {
            this.value = this.value.replace(/\D/g, '').slice(0, 16);
        });

        // Allow only numbers and restrict length to 4 digits for CCV
        ccvInput.addEventListener('input', function () {
            this.value = this.value.replace(/\D/g, '').slice(0, 4);
        });

        // Real-time validation for the name input
        document.getElementById('nome').addEventListener('input', function () {
            // Allow only letters and spaces
            this.value = this.value.replace(/[^A-Za-z\s]/g, '');
        });

        // Validating the expiration date to ensure it's in the future
        document.getElementById('data_scadenza').addEventListener('change', function () {
            const oggi = new Date();
            const dataInput = new Date(this.value);
            if (dataInput <= oggi) {
                alert('La data di scadenza deve essere successiva alla data attuale.');
                this.value = ''; // Clear the invalid input
            }
        });

        // Recupera i dati del carrello e visualizzali
        fetch('php/shop.php', {
            method: 'POST',
            body: new URLSearchParams('action=getCart')
        })
        .then(response => response.json())
        .then(cartItems => {
            let subtotal = 0;
            const boughtItemsContainer = document.getElementById('bought-items');
            boughtItemsContainer.innerHTML = '';

            cartItems.forEach(item => {
                const itemPrice = parseFloat(item.price); // Ensure item.price is a number
                const itemTotal = itemPrice * item.quantity;
                subtotal += itemTotal;

                const itemElement = document.createElement('div');
                itemElement.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="product-image">
                    <h3 class="bought-items">${item.name}</h3>
                    <p class="bought-items description">Quantità: ${item.quantity}</p>
                    <p class="bought-items description">Taglia: ${item.size}</p>
                    <p class="bought-items price">Prezzo: €${itemPrice.toFixed(2)} cad.</p>
                `;
                boughtItemsContainer.appendChild(itemElement);
            });

            document.getElementById('subtotal').textContent = `€${subtotal.toFixed(2)}`;
        })
        .catch(error => console.error('Errore nel recupero dei dati del carrello:', error));

        // Recupera il nome e il cognome dell'utente e visualizzali
        fetch('php/payment.php?action=getUser')
        .then(response => response.json())
        .then(user => {
            const capitalize = str => str.replace(/\b\w/g, char => char.toUpperCase());
            const nome = capitalize(user.nome);
            const cognome = capitalize(user.cognome);
            document.getElementById('user-name').textContent = `${nome} ${cognome}`;
        })
        .catch(error => console.error('Errore nel recupero dei dati dell\'utente:', error));

        // Print the page when the form is submitted
        document.getElementById('cardForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission
            window.print(); // Open the print dialog
            this.submit(); // Submit the form after printing
        });
    </script>
</body>
</html>
