<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Linkin Park</title>
    <meta name="author" content="linkins">
    <meta name="description" content="TODO">
    <meta name="keywords" content="TODO">
    <meta name="viewport" content="width=device-width">
    
    <link rel="stylesheet" href="asset/css/pagamento.css" media="screen">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="icon" href="asset/img/favicon.ico" type="image/x-icon">
</head>
<body>
    <form id="cardForm" action="php/pagamento.php" method="POST">
        <div class="container">
            <div class="left-section">
                <section class="card" aria-labelledby="card-section" role="form">
                    <h2 id="card-section">Dettagli della Carta</h2>
                    
                    <button class="proceed" type="submit" aria-label="Procedi al pagamento" accesskey="p">
                        <p class="confirmation">Conferma Pagamento</p>
                    </button>
        
                    <i class="fa-solid fa-building-columns" aria-hidden="true"></i>
        
                    <label for="n_carta" accesskey="n">Numero della carta:</label>
                    <input id="n_carta" type="text" class="input n_carta" name="n_carta" 
                        placeholder="1234 5678 9101 1121" maxlength="16" required aria-required="true">
        
                    <label for="nome" accesskey="o">Nome completo del proprietario della carta:</label>
                    <input id="nome" class="input nome" name="nome" placeholder="Mario Rossi" required aria-required="true">
        
                    <label for="data_scadenza" accesskey="d">Data di scadenza:</label>
                    <input type="date" id="data_scadenza" name="data_scadenza" required aria-required="true">
        
                    <label for="ccv" class="toleft" accesskey="c">CCV (codice di sicurezza):</label>
                    <input id="ccv" class="input toleft ccv" name="ccv" placeholder="321" maxlength="4" required aria-required="true">
                </section>
        
                <section class="data" role="data" aria-labelledby="data-section">
                    <article class="col receipt-details" aria-labelledby="receipt-details">
                        <h2 id="receipt-details">Dettagli del pagamento</h2>
                        <p>Totale:</p>
                        <h3 class="cost" id="subtotal" aria-live="polite">€0.00</h3>
                        <p>Utente:</p>
                        <h3 class="user" id="user-name" aria-live="polite">Nome Cognome</h3>
                    </article>
                </section>
            </div>

            <section class="receipt" role="region" aria-labelledby="receipt-section">
                <h2 id="receipt-section">Dettagli della ricevuta</h2>
                
                <article class="col" id="bought-items-container" aria-labelledby="bought-items-title">
                    <h3 id="bought-items-title">Lista degli acquisti:</h3>
                    <div id="bought-items" aria-live="polite">
                        <!-- I prodotti del carrello verranno aggiunti qui tramite JavaScript -->
                    </div>
                </article>
            </section>
        </div>
    </form>
    
    <!-- Gestione Carta-->
    <script>
        // Real-time validation for the card number input
        const nCartaInput = document.getElementById('n_carta');
        const ccvInput = document.getElementById('ccv');

        // Allow only numbers and restrict length to 16 digits for card number
        nCartaInput.addEventListener('input', function () {
            this.value = this.value.replace(/\D/g, '').slice(0, 16);
        });

        // Allow only numbers and restrict length to 4 digits for CCV
        ccvInput.addEventListener('input', function () {
            this.value = this.value.replace(/\D/g, '').slice(0, 4);
        });

        // Real-time validation for the name input
        document.getElementById('nome').addEventListener('input', function () {
            // Allow only letters and spaces
            this.value = this.value.replace(/[^A-Za-z\s]/g, '');
        });

        // Validating the expiration date to ensure it's in the future
        document.getElementById('data_scadenza').addEventListener('change', function () {
            const oggi = new Date();
            const dataInput = new Date(this.value);
            if (dataInput <= oggi) {
                alert('La data di scadenza deve essere successiva alla data attuale.');
                this.value = ''; // Clear the invalid input
            }
        });

        // Recupera i dati del carrello e visualizzali
        fetch('php/shop.php', {
            method: 'POST',
            body: new URLSearchParams('action=getCart')
        })
        .then(response => response.json())
        .then(cartItems => {
            let subtotal = 0;
            const boughtItemsContainer = document.getElementById('bought-items');
            boughtItemsContainer.innerHTML = '';

            cartItems.forEach(item => {
                const itemPrice = parseFloat(item.price); // Ensure item.price is a number
                const itemTotal = itemPrice * item.quantity;
                subtotal += itemTotal;

                const itemElement = document.createElement('div');
                itemElement.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="product-image">
                    <div class="bought-item-details">
                        <h4 class="bought-items">${item.name}</h4>
                        <p class="bought-items description">Quantità: ${item.quantity}</p>
                        ${item.size ? `<p class="bought-items description">Taglia: ${item.size}</p>` : ''}
                        <p class="bought-items price">Prezzo: €${itemPrice.toFixed(2)} <abbr title="ciascuno">cad.</abbr></p>
                    </div>
                `;
                boughtItemsContainer.appendChild(itemElement);
            });

            document.getElementById('subtotal').textContent = `€${subtotal.toFixed(2)}`;
        })
        .catch(error => console.error('Errore nel recupero dei dati del carrello:', error));

        // Recupera il nome e il cognome dell'utente e visualizzali
        fetch('php/pagamento.php?action=getUser')
        .then(response => response.json())
        .then(user => {
            const capitalize = str => str.replace(/\b\w/g, char => char.toUpperCase());
            const nome = capitalize(user.nome);
            const cognome = capitalize(user.cognome);
            document.getElementById('user-name').textContent = `${nome} ${cognome}`;
        })
        .catch(error => console.error('Errore nel recupero dei dati dell\'utente:', error));

        // Print the page when the form is submitted
        document.getElementById('cardForm').addEventListener('submit', function(event) {
            if (nomeInput.value.trim() === '') {
                alert('Il campo del nome non può essere vuoto o contenere solo spazi.');
                event.preventDefault(); // Prevent the form from being submitted
            } else {
                window.print(); // Open the print dialog
                this.submit(); // Submit the form after printing
            }
        });
    </script>

    <!-- Controllo dell'altezza dello scontrino --> <!-- NON TOGLIERE -->
    <script>
        function setRelativeHeight(referenceSelector, targetSelector) {
            var referenceElement = document.querySelector(referenceSelector);
            var targetElement = document.querySelector(targetSelector);

            if (referenceElement && targetElement) {
                var referenceHeight = referenceElement.offsetHeight;
                targetElement.style.maxHeight = referenceHeight + 'px';
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            setRelativeHeight('.left-section', '.receipt');
        });
    </script>
</body>
</html>
